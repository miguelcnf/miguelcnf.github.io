<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="Miguel Fonseca" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="components/core/assets/favicon.ico">
    <title>miguelcnf.com</title>

    <link rel="stylesheet" href="components/ext/css/bootstrap.min.css" />
    <link rel="stylesheet" href="components/ext/css/blog.css" />
    <!--[if lt IE 9]>
      <script src="components/ext/js/html5shiv.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48391305-1', 'miguelcnf.com');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript">
      var disqus_shortname = 'miguelcnfcom'; // required: replace example with your forum shortname
      var disqus_identifier = 'ruby-fun-in-shallow-water';
      var disqus_title = 'ruby-fun-in-shallow-water';
      var disqus_url = 'http://miguelcnf.com/posts/2014/12/06/ruby-fun-in-shallow-water.html';

      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <div class="blog-header">
        <p class="lead blog-description">Web ninja wandering stealthily between Dev and Ops.</p>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">
          <div class="blog-post">
            <article>
              <h2 class="blog-post-title">Ruby Fun in Shallow Water</h2>
              <p>Ruby is shiny, but also shallow.</p>
              <hr>
              <p>I spent some time this week understanding the difference between Ruby shallow and deep patterns when copying objects.</p>

              <p>First let's start with the basics - everything in Ruby is an object - Strings, Integers, Arrays, Hashes, they all inherit from Object.</p>

              <p>Because of that they all share some basic behaviours but they also re-implement class-specific methods.</p>

              <p>I had some fun looking at the behaviour of assigments and object cloning.</p>

              <p>Let's dig in. Assume you're assigning values with the = operator like:</p>

              <pre><code>
[1] pry(main)> x = 'foo'
=> "foo"
              </code></pre>

              <p>According to the docs this will assign the value <strong>'foo'</strong> to the variable <strong>x</strong>, which it does.</p>

              <p>Now let's see what happens if we assign the <strong>x</strong> variable to a new variable <strong>y</strong> and update it right after:</p>

              <pre><code>
[1] pry(main)> x = 'foo'
=> "foo"
[2] pry(main)> y = x
=> "foo"
[3] pry(main)> y = 'bar'
=> "bar"
[4] pry(main)> x
=> "foo"
              </code></pre>

              <p>The variable <strong>y</strong> gets assigned the value of the variable <strong>x</strong> and as it is a new object, it can be updated without changing the value of the original variable <strong>x</strong>.</p>

              <p>This works as expected for both Strings or Integers but what about Hashes? Let's try it:</p>

              <pre><code>
[1] pry(main)> x = { :a => 'foo' }
=> {:a=>"foo"}
[2] pry(main)> y = x
=> {:a=>"foo"}
[3] pry(main)> y[:a] = 'bar'
=> "bar"
[4] pry(main)> x
=> {:a=>"bar"}
              </code></pre>

              <p>Ok that's not exactly what we were expecting.</p>

              <p>Apparently assigning Hashes with the <strong>=</strong> operator triggers a copy as reference instead of a copy as value as with the Strings example.</p>

              <p>We can actually confirm it by checking the id of the objects created on both examples:</p>

              <pre><code>
[3] pry(main)> y = 'bar'
=> "bar"
[4] pry(main)> x
=> "foo"
[5] pry(main)> x.__id__
=> 70146790902100
[6] pry(main)> y.__id__
=> 70146790415460
              </code></pre>

              <p>And:</p>

              <pre><code>
[3] pry(main)> y[:a] = 'bar'
=> "bar"
[4] pry(main)> x
=> {:a=>"bar"}
[5] pry(main)> x.__id__
=> 70361740329340
[6] pry(main)> y.__id__
=> 70361740329340
              </code></pre>

              <p>As we can see <strong>y</strong> and <strong>x</strong> are in fact the same Hash object in the second snippet.</p>

              <p>So, at this point I was thinking the Hash object overrides the behaviour of the <strong>=</strong> operator to copy as reference, then how do I copy by it as value? A quick search in the docs pointed me to one of the <strong>.dup</strong> or <strong>.clone</strong> methods.</p>

              <p>In a nutshell they're the same, with the difference that the <strong>.clone</strong> method copies the frozen state of the original object. I didn't really need that so I went with the <strong>.dup</strong> method:</p>

              <pre><code>
[1] pry(main)> x = { :a => 'foo' }
=> {:a=>"foo"}
[2] pry(main)> y = x.dup
=> {:a=>"foo"}
[3] pry(main)> y[:a] = 'bar'
=> "bar"
[4] pry(main)> x
=> {:a=>"foo"}
[5] pry(main)> x.__id__
=> 70235021806240
[6] pry(main)> y.__id__
=> 70235021750880
              </code></pre>

              <p>Awesome! At this point I had a way of doing copies as value that worked on all the object types I needed.</p>

              <p>Then I had my <em>'WTF? Ruby is broken!'</em> moment:</p>

              <pre><code>
[1] pry(main)> x = {:a => 'foo', :b => [{ :z => 10, :w => 20 }]}
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
[2] pry(main)> y = x.dup
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
[3] pry(main)> y[:a] = 'bar'
=> "bar"
[4] pry(main)> x
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
[5] pry(main)> y[:b][0][:z] = 30
=> 30
[6] pry(main)> y
=> {:a=>"bar", :b=>[{:z=>30, :w=>20}]}
[7] pry(main)> x
=> {:a=>"foo", :b=>[{:z=>30, :w=>20}]}
              </code></pre>

              <p>What? Let's see:</p>

              <pre><code>
[8] pry(main)> y[:a].__id__
=> 70191665153600
[9] pry(main)> x[:a].__id__
=> 70191661721380
[10] pry(main)> y[:b].__id__
=> 70191661721320
[11] pry(main)> x[:b].__id__
=> 70191661721320
              </code></pre>

              <p>Why did <strong>:a</strong> was copied as value but <strong>:b</strong> as a reference?</p>

              <p>A quick google search led me back to the docs of the <strong>.dup</strong> method, the answer was already there I just had missed it:</p>

              <blockquote><em>"Produces a shallow copy (..) the instance variables of obj are copied, but not the objects they reference"</em></blockquote>

              <p>What that means is that the <strong>.dup</strong> method will copy as value all the instance variables but not any other object the instance references.</p>

              <p>If we look at our example:</p>

              <pre><code>
x = {:a => 'foo', :b => [{ :z => 10, :w => 20 }]}
              </code></pre>

              <p>Here <strong>:a</strong> is an instance variable of a String object while <strong>:b</strong> actually references another instance Array object:</p>

              <pre><code>
[12] pry(main)> y[:b][0].__id__
=> 70191661721340
[13] pry(main)> x[:b][0].__id__
=> 70191661721340
              </code></pre>

              <p>This is what the docs meant by shallow copy.</p>

              <p>After a quick google search I endend up realising that I wasn't alone on this line of thought and that a common way of achieving a deep copy as value of an Hash object was:</p>

              <pre><code>
[1] pry(main)> x = {:a => 'foo', :b => [{ :z => 10, :w => 20 }]}
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
[2] pry(main)> y = Marshal.load(Marshal.dump(x))
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
[3] pry(main)> y[:b][0][:z] = 30
=> 30
[4] pry(main)> x
=> {:a=>"foo", :b=>[{:z=>10, :w=>20}]}
              </code></pre>

              <p>This is using the Marshal object to dump the Hash object <strong>x</strong> into byte stream and then re-creating a new Hash object <strong>y</strong> from it.</p>

              <p>We now have two complete unique Hash instances to work with:</p>

              <pre><code>
[5] pry(main)> x.__id__
=> 70234359976480
[6] pry(main)> y.__id__
=> 70234359434480
[7] pry(main)> x[:b][0].__id__
=> 70234359976600
[8] pry(main)> y[:b][0].__id__
=> 70234359434200
              </code></pre>

              <p>I realise that this might seem like common sense to any Ruby gurus out there but I had some fun figuring it out.</p>
            </article>
          </div> <!-- ./blog-post -->
          <div id="disqus_thread"></div> <!-- disqus -->
        </div> <!-- ./blog-main col -->
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          <div class="sidebar-module sidebar-module-inset">
            <h4>About:</h4>
            <p>Record of thoughts, hacks and general ninjaness that goes on in my mind.</p>
          </div>
          <div class="sidebar-module">
            <h4>Posts:</h4>
            <ul class="list-unstyled">
              <li><a href="posts/2014/02/23/what-do-you-think-devops-is.html">What do you think DevOps is?</a></li>
              <li><a href="posts/2014/02/28/throw-your-personal-agenda-in-the-can.html">Throw your personal agenda in the can</a></li>
              <li><a href="posts/2014/06/17/zero-lines-of-code.html">Zero lines of code</a></li>
              <li><a href="posts/2014/09/25/the-snowflake-mindset.html">The Snowflake Mindset</a></li>
              <li><a href="posts/2014/10/16/boxing-champ.html">Boxing Champ</a></li>
              <li><a href="posts/2014/12/06/ruby-fun-in-shallow-water.html">Ruby Fun in Shallow Water</a></li>
            </ul>
          </div>
        </div> <!-- sidebar -->
      </div> <!-- row -->
    </div> <!-- container -->
    <div class="blog-footer">
      <footer>
        <p>Built with <a href="http://getbootstrap.com" target="_blank">Bootstrap</a> by <a href="https://twitter.com/miguelcnf" target="_blank">@miguelcnf</a>.</p>
      </footer>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="components/ext/js/bootstrap.min.js"></script>
  </body>
</html>
